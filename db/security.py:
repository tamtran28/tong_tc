import streamlit as st
from auth_jwt import decode_access_token
from db.auth_db import *


def logout():
    for key in list(st.session_state.keys()):
        del st.session_state[key]


def get_current_user():
    token = st.session_state.get("access_token")
    if not token:
        return None

    payload = decode_access_token(token)
    if not payload:
        # Token háº¿t háº¡n / lá»—i â†’ logout
        logout()
        return None

    return payload  # {'sub': username, 'role': role, 'full_name': ...}


def require_login():
    user = get_current_user()
    if not user:
        st.warning("âš ï¸ PhiÃªn Ä‘Äƒng nháº­p háº¿t háº¡n hoáº·c chÆ°a Ä‘Äƒng nháº­p.")
        st.stop()
    return user


def require_role(roles: list[str]):
    user = require_login()
    if user.get("role") not in roles:
        st.error("ğŸš« Báº¡n khÃ´ng cÃ³ quyá»n truy cáº­p chá»©c nÄƒng nÃ y.")
        st.stop()
    return user
